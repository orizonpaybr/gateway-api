================================================================================
                    MAPA MENTAL - SISTEMA DE PERMISS√ïES E GATEWAY
                           An√°lise do Sistema Laravel para Go
================================================================================

üìã 1. ESTRUTURA DE USU√ÅRIOS E PERMISS√ïES
================================================================================

Tipos de Usu√°rios (Campo 'permission'):
- permission = 1: Usu√°rio comum (padr√£o)
- permission = 3: Administrador  
- permission = 5: Gerente
- status: Controla se conta est√° ativa (1 = ativa, outros = pendente/banida)

Campos de Seguran√ßa do Usu√°rio:
- twofa_enabled + twofa_secret: Autentica√ß√£o de 2 fatores
- whitelisted_ip: IPs permitidos para saques
- gerente_id + gerente_percentage + gerente_aprovar: Sistema de gerentes
- webhook_url + webhook_endpoint: Configura√ß√µes de webhook
- taxas_personalizadas_ativas: Taxas customizadas por usu√°rio

Campos Principais da Tabela Users:
- id, name, email, password, username
- cpf_cnpj, data_nascimento, telefone
- saldo, total_transacoes, permission, status
- avatar, data_cadastro, ip_user
- transacoes_aproved, transacoes_recused
- valor_sacado, valor_saque_pendente
- taxa_cash_in, taxa_cash_out, taxa_cash_in_fixa, taxa_cash_out_fixa
- token, banido, cliente_id, taxa_percentual
- volume_transacional, valor_pago_taxa, user_id
- cep, rua, estado, cidade, bairro, numero_residencia, complemento
- foto_rg_frente, foto_rg_verso, selfie_rg, media_faturamento
- indicador_ref, whitelisted_ip, pushcut_pixpago
- twofa_secret, twofa_enabled, twofa_enabled_at
- code_ref, gerente_id, gerente_percentage, gerente_aprovar
- webhook_url, webhook_endpoint
- taxas_personalizadas_ativas, taxa_flexivel_ativa
- taxa_flexivel_valor_minimo, taxa_flexivel_fixa_baixo
- taxa_flexivel_percentual_alto, taxa_saque_api, taxa_saque_cripto

================================================================================
üîê 2. SISTEMA DE AUTENTICA√á√ÉO
================================================================================

A. Autentica√ß√£o Web (Sess√£o)
- Middleware: AuthMiddleware
- Verifica√ß√µes:
  * Usu√°rio autenticado (auth()->check())
  * Status da conta (status === 1)
  * Redirecionamento para login se n√£o autenticado

B. Autentica√ß√£o API (Token/Secret)
- Middleware: CheckTokenAndSecret
- Verifica√ß√µes:
  * Token e Secret obrigat√≥rios no body
  * Valida√ß√£o contra tabela users_key
  * Status da conta (status === 1)
  * Logs de seguran√ßa detalhados

C. Autentica√ß√£o 2FA
- Biblioteca: Google2FA (PragmaRX)
- Fluxo:
  1. Login normal
  2. Se twofa_enabled = true ‚Üí logout tempor√°rio
  3. Redirecionamento para tela de 2FA
  4. Verifica√ß√£o do c√≥digo de 6 d√≠gitos
  5. Login final baseado na permiss√£o

Tabela users_key:
- user_id: Refer√™ncia ao usu√°rio
- token: Token de acesso
- secret: Chave secreta
- status: Status da chave

================================================================================
üõ°Ô∏è 3. SISTEMA DE MIDDLEWARES
================================================================================

A. Middlewares de Autentica√ß√£o
- check.auth => AuthMiddleware::class           // Usu√°rio autenticado
- check.admin => AdminMiddleware::class         // Permission = 3
- check.token.secret => CheckTokenAndSecret::class  // API auth

B. Middlewares de Seguran√ßa
- security => SecurityMiddleware::class         // Headers + bloqueio de ataques
- validate.webhook => ValidateWebhook::class    // Valida√ß√£o de webhooks
- check.allowed.ip => CheckAllowedIP::class     // Controle de IP
- check.pin => CheckPin::class                  // Verifica√ß√£o de PIN

C. Middlewares Globais
- SecurityMiddleware: Aplicado globalmente
- AssetOptimizerMiddleware: Otimiza√ß√£o de assets
- AtualizarSaldosClientes: Atualiza√ß√£o de saldos

D. Middlewares de Rate Limiting
- throttle:60,1: 60 requests por minuto
- throttle:30,1: 30 requests por minuto
- throttle:20,1: 20 requests por minuto
- throttle:10,1: 10 requests por minuto
- throttle:5,1: 5 requests por minuto

================================================================================
üõ£Ô∏è 4. SISTEMA DE ROTAS E PERMISS√ïES
================================================================================

A. Rotas P√∫blicas
- / - Landing page
- /callback/* - Webhooks de adquirentes
- /login, /register - Autentica√ß√£o
- /2fa/verify - Verifica√ß√£o 2FA

B. Rotas Autenticadas (auth + verified)
- /dashboard - Dashboard principal
- /enviar-doc - Envio de documentos
- /webhook - Configura√ß√£o de webhooks
- /documentacao - Documenta√ß√£o
- /my-profile, /profile - Gerenciamento de perfil
- /profile/add-ip, /profile/remove-ip - Gest√£o de IPs
- /profile/create-pin, /profile/change-pin - Gest√£o de PIN
- /2fa/status, /2fa/generate-qr, /2fa/verify - 2FA
- /relatorio/* - Relat√≥rios financeiros
- /financeiro - √Årea financeira
- /chaves - Chaves API
- /produtos/* - Gest√£o de produtos/checkout
- /integracoes/* - Integra√ß√µes

C. Rotas de Ger√™ncia (check.auth)
- /gerencia/clientes - Gest√£o de clientes
- /gerencia/relatorio - Relat√≥rios de clientes
- /gerencia/material - Material de apoio
- /gerencia/cliente/detalhes/{id} - Detalhes do cliente
- /gerencia/cliente/status - Mudan√ßa de status
- /gerencia/cliente/edit/{id} - Edi√ß√£o de cliente

D. Rotas Administrativas (check.admin)
- /{ADM_ROUTE}/dashboard - Dashboard admin
- /{ADM_ROUTE}/usuarios - Gest√£o de usu√°rios
- /{ADM_ROUTE}/usuario/detalhes/{id} - Detalhes do usu√°rio
- /{ADM_ROUTE}/usuario/status - Mudan√ßa de status
- /{ADM_ROUTE}/usuario/delete/{id} - Exclus√£o de usu√°rio
- /{ADM_ROUTE}/usuario/edit/{id} - Edi√ß√£o de usu√°rio
- /{ADM_ROUTE}/financeiro/* - √Årea financeira admin
- /{ADM_ROUTE}/transacoes/* - Gest√£o de transa√ß√µes
- /{ADM_ROUTE}/aprovar-saques - Aprova√ß√£o de saques
- /{ADM_ROUTE}/saque-config - Configura√ß√£o de saques
- /{ADM_ROUTE}/ajustes/* - Configura√ß√µes do sistema

E. Rotas API (check.token.secret)
- /api/wallet/deposit/payment - Dep√≥sitos (throttle:60,1)
- /api/pixout - Saques (check.allowed.ip + throttle:30,1)
- /api/status - Status de transa√ß√µes (throttle:20,1)
- /api/billet/charge - Boletos (throttle:5,1)

F. Rotas de Webhook (validate.webhook)
- /api/pixup/callback/deposit - Callback dep√≥sito Pixup
- /api/pixup/callback/withdraw - Callback saque Pixup
- /api/pixup/test - Teste de webhook Pixup

================================================================================
üîí 5. SISTEMA DE SEGURAN√áA
================================================================================

A. Valida√ß√£o de Webhooks
Adquirentes suportados:
- Pixup: X-Pixup-Signature (HMAC-SHA256)
- Woovi: authorization (campo do body)
- EFI: X-EFI-Signature (HMAC-SHA256)
- XGate: X-XGate-Signature (HMAC-SHA256)
- Cashtime: X-Cashtime-Signature (HMAC-SHA256)
- MercadoPago: X-MercadoPago-Signature (HMAC-SHA256)
- Pagarme: X-Pagarme-Signature (HMAC-SHA256)
- Witetec: X-Witetec-Signature (HMAC-SHA256)

B. Controle de IP
- IPs Globais: Configurados na tabela app (campo global_ips)
- IPs por Usu√°rio: Campo whitelisted_ip
- Trait: IPManagementTrait para valida√ß√£o
- IP do servidor para saques via interface web: 54.232.237.217

C. Headers de Seguran√ßa
- X-Content-Type-Options: nosniff
- X-Frame-Options: DENY
- X-XSS-Protection: 1; mode=block
- Referrer-Policy: strict-origin-when-cross-origin
- Permissions-Policy: geolocation=(), microphone=(), camera=()

D. Bloqueio de Ataques
- Arquivos PHP em uploads (extens√µes: php, phtml, php3, php4, php5)
- Padr√µes suspeitos:
  * /eval\s*\(/i
  * /base64_decode/i
  * /shell_exec/i
  * /system\s*\(/i
  * /exec\s*\(/i
  * /passthru/i
  * /<\?php/i
  * /\$_GET\[/i
  * /\$_POST\[/i
- Logs detalhados de tentativas

E. Sistema de PIN
- Verifica√ß√£o obrigat√≥ria para opera√ß√µes sens√≠veis
- PIN configurado por usu√°rio
- Valida√ß√£o via PinManagementTrait

================================================================================
üèÜ 6. SISTEMA DE N√çVEIS
================================================================================

Estrutura da Tabela niveis:
- id: Identificador √∫nico
- nome: Nome do n√≠vel
- cor: Cor do n√≠vel
- icone: √çcone do n√≠vel
- minimo: Valor m√≠nimo para o n√≠vel
- maximo: Valor m√°ximo para o n√≠vel
- timestamps: created_at, updated_at

Helper meuNivel():
- Soma dep√≥sitos pagos do usu√°rio (status = 'PAID_OUT')
- Encontra n√≠vel atual baseado na faixa de valores
- Retorna pr√≥ximo n√≠vel dispon√≠vel
- C√°lculo baseado em dep√≥sitos totais

================================================================================
üéõÔ∏è 7. CONFIGURA√á√ïES GLOBAIS
================================================================================

Tabela app:
- global_ips: IPs globalmente permitidos (JSON)
- niveis_ativo: Sistema de n√≠veis ativo/inativo
- Outras configura√ß√µes do sistema

================================================================================
üöÄ IMPLEMENTA√á√ÉO EM GO - CHECKLIST DETALHADO
================================================================================

1. ESTRUTURAS DE DADOS
----------------------
[ ] Struct User com todos os campos
[ ] Struct UsersKey para API keys
[ ] Struct Nivel para sistema de n√≠veis
[ ] Struct App para configura√ß√µes globais
[ ] Structs para cada adquirente (Pixup, Woovi, EFI, etc.)
[ ] Structs para transa√ß√µes e solicita√ß√µes

2. MIDDLEWARES
--------------
[ ] AuthMiddleware - Verifica√ß√£o de sess√£o
[ ] AdminMiddleware - Verifica√ß√£o de permiss√£o 3
[ ] TokenSecretMiddleware - Autentica√ß√£o API
[ ] SecurityMiddleware - Headers e bloqueios
[ ] WebhookValidationMiddleware - Valida√ß√£o de webhooks
[ ] IPCheckMiddleware - Controle de IP
[ ] PinMiddleware - Verifica√ß√£o de PIN
[ ] RateLimitMiddleware - Controle de taxa
[ ] CSRFMiddleware - Prote√ß√£o CSRF

3. AUTENTICA√á√ÉO
---------------
[ ] Sistema de sess√µes (Gorilla Sessions)
[ ] Gera√ß√£o e valida√ß√£o de tokens API
[ ] Implementa√ß√£o 2FA (Google2FA)
[ ] Sistema de login/logout
[ ] Hash de senhas (bcrypt)
[ ] Gera√ß√£o de QR codes para 2FA

4. ROTEAMENTO
-------------
[ ] Grupo de rotas p√∫blicas
[ ] Grupo de rotas autenticadas
[ ] Grupo de rotas de ger√™ncia
[ ] Grupo de rotas administrativas
[ ] Grupo de rotas API
[ ] Middleware de roteamento por grupos

5. SEGURAN√áA
------------
[ ] Valida√ß√£o de webhooks por adquirente
[ ] Controle de IPs permitidos
[ ] Headers de seguran√ßa
[ ] Bloqueio de ataques comuns
[ ] Logs de seguran√ßa estruturados
[ ] Valida√ß√£o de entrada de dados
[ ] Sanitiza√ß√£o de inputs

6. SISTEMA DE N√çVEIS
--------------------
[ ] C√°lculo autom√°tico de n√≠veis
[ ] CRUD de n√≠veis
[ ] Ativa√ß√£o/desativa√ß√£o do sistema
[ ] Interface para gerenciamento

7. BANCO DE DADOS
-----------------
[ ] Migrations para todas as tabelas
[ ] Relacionamentos entre tabelas
[ ] √çndices para performance
[ ] Constraints de integridade
[ ] Triggers para c√°lculos autom√°ticos

8. CONFIGURA√á√ïES
----------------
[ ] Arquivo de configura√ß√£o (.env)
[ ] Configura√ß√µes por ambiente
[ ] Valida√ß√£o de configura√ß√µes
[ ] Hot reload de configura√ß√µes

9. LOGS E MONITORAMENTO
-----------------------
[ ] Sistema de logs estruturado
[ ] Logs de seguran√ßa
[ ] Logs de transa√ß√µes
[ ] M√©tricas de performance
[ ] Alertas de seguran√ßa

10. TESTES
----------
[ ] Testes unit√°rios para middlewares
[ ] Testes de integra√ß√£o para rotas
[ ] Testes de seguran√ßa
[ ] Testes de performance
[ ] Mocks para depend√™ncias externas

11. DOCUMENTA√á√ÉO
----------------
[ ] Documenta√ß√£o da API
[ ] Documenta√ß√£o de seguran√ßa
[ ] Guia de implementa√ß√£o
[ ] Exemplos de uso

12. DEPLOY E INFRAESTRUTURA
---------------------------
[ ] Dockerfile
[ ] Docker Compose
[ ] Scripts de deploy
[ ] Configura√ß√£o de proxy reverso
[ ] SSL/TLS
[ ] Backup autom√°tico

================================================================================
üìù NOTAS IMPORTANTES PARA IMPLEMENTA√á√ÉO
================================================================================

1. O sistema usa Laravel Sanctum para autentica√ß√£o API, mas voc√™ pode usar
   JWT ou similar em Go.

2. O sistema de sess√µes do Laravel √© robusto, considere usar Redis para
   sess√µes em Go.

3. O sistema de middlewares do Laravel √© muito flex√≠vel, implemente algo
   similar com interfaces em Go.

4. O sistema de valida√ß√£o de webhooks √© cr√≠tico para seguran√ßa, implemente
   com cuidado.

5. O sistema de n√≠veis √© baseado em dep√≥sitos totais, implemente com
   triggers ou jobs em background.

6. O sistema de logs √© extensivo, use structured logging em Go.

7. O sistema de rate limiting √© importante para APIs, implemente com
   Redis ou similar.

8. O sistema de 2FA usa Google2FA, h√° bibliotecas equivalentes em Go.

9. O sistema de controle de IP √© complexo, implemente com CIDR blocks.

10. O sistema de webhooks √© ass√≠ncrono, considere usar workers/queues.

================================================================================
üéØ PR√ìXIMOS PASSOS RECOMENDADOS
================================================================================

1. Comece com as estruturas de dados b√°sicas
2. Implemente o sistema de autentica√ß√£o
3. Crie os middlewares essenciais
4. Implemente as rotas b√°sicas
5. Adicione o sistema de seguran√ßa
6. Implemente o sistema de n√≠veis
7. Adicione logs e monitoramento
8. Crie testes abrangentes
9. Documente tudo
10. Fa√ßa deploy e monitore

================================================================================
